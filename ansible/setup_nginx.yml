---
- name: Setup Nginx Web Server
  hosts: private_hosts
  become: true

  tasks:
    # ==========================================
    # STEP 1: Install Nginx
    # ==========================================

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Ensure Nginx service is enabled and started
      ansible.builtin.systemd:
        name: nginx
        enabled: yes
        state: started

    # ==========================================
    # STEP 2: Configure Nginx
    # ==========================================

    - name: Create custom Nginx configuration
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/default
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              root /var/www/html;
              index index.html index.htm index.nginx-debian.html;

              server_name _;

              # Logging
              access_log /var/log/nginx/access.log;
              error_log /var/log/nginx/error.log;

              location / {
                  try_files $uri $uri/ =404;
              }

              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 "OK\n";
                  add_header Content-Type text/plain;
              }

              # Server status for monitoring
              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  allow 192.168.10.0/24;
                  deny all;
              }
          }
        mode: '0644'
        owner: root
        group: root
      notify: restart nginx

    - name: Create custom welcome page
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>GS Lab - Nginx Server</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      background: white;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      padding: 50px;
                      max-width: 800px;
                      text-align: center;
                  }
                  h1 {
                      color: #2ecc71;
                      font-size: 3em;
                      margin-bottom: 20px;
                  }
                  h2 {
                      color: #27ae60;
                      font-size: 1.5em;
                      margin-bottom: 30px;
                  }
                  .info-box {
                      background: #f7f7f7;
                      border-radius: 10px;
                      padding: 20px;
                      margin: 20px 0;
                      text-align: left;
                  }
                  .info-box h3 {
                      color: #2ecc71;
                      margin-bottom: 15px;
                  }
                  .info-box ul {
                      list-style: none;
                      padding-left: 0;
                  }
                  .info-box li {
                      padding: 8px 0;
                      border-bottom: 1px solid #e0e0e0;
                  }
                  .info-box li:last-child {
                      border-bottom: none;
                  }
                  .info-box li strong {
                      color: #27ae60;
                      display: inline-block;
                      width: 200px;
                  }
                  .status {
                      display: inline-block;
                      padding: 5px 15px;
                      background: #2ecc71;
                      color: white;
                      border-radius: 20px;
                      font-size: 0.9em;
                      margin-top: 20px;
                  }
                  .badge {
                      display: inline-block;
                      padding: 5px 10px;
                      background: #3498db;
                      color: white;
                      border-radius: 5px;
                      font-size: 0.8em;
                      margin-left: 10px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üåê Nginx Server</h1>
                  <h2>Private Network - GS Lab</h2>
                  <span class="status">‚úì Online</span>
                  <span class="badge">Private IP: 192.168.10.2</span>
                  
                  <div class="info-box">
                      <h3>üìä Server Information</h3>
                      <ul>
                          <li><strong>Web Server:</strong> Nginx</li>
                          <li><strong>Network:</strong> Private (192.168.10.0/24)</li>
                          <li><strong>Access:</strong> Via Caddy Gateway</li>
                          <li><strong>Status:</strong> Running</li>
                      </ul>
                  </div>
                  
                  <div class="info-box">
                      <h3>üîó Available Endpoints</h3>
                      <ul>
                          <li><strong>Main Page:</strong> /</li>
                          <li><strong>Health Check:</strong> /health</li>
                          <li><strong>Server Status:</strong> /nginx_status (internal only)</li>
                      </ul>
                  </div>

                  <div class="info-box">
                      <h3>üîí Security</h3>
                      <ul>
                          <li><strong>Network:</strong> Private network only</li>
                          <li><strong>Access:</strong> Through Caddy gateway (185.241.34.22)</li>
                          <li><strong>SSH:</strong> Via ProxyJump through Caddy</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
        mode: '0644'
        owner: www-data
        group: www-data

    # ==========================================
    # STEP 3: Verification
    # ==========================================

    - name: Ensure Nginx is running
      ansible.builtin.systemd:
        name: nginx
        state: started

    - name: Wait for Nginx to be ready
      ansible.builtin.uri:
        url: http://localhost:80
        status_code: 200
      register: nginx_check
      until: nginx_check.status == 200
      retries: 5
      delay: 2

    - name: Check Nginx health endpoint
      ansible.builtin.uri:
        url: http://localhost:80/health
        return_content: yes
      register: nginx_health
      failed_when: false

    - name: Get Nginx version
      ansible.builtin.command: nginx -v
      register: nginx_version
      changed_when: false

    - name: Display Nginx setup summary
      ansible.builtin.debug:
        msg: |
            Nginx Web Server: RUNNING

  handlers:
    - name: restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted
